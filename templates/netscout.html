<!doctype html>
<html lang="en">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>Net-Scout â€” Investigate Alerts</title>

  <link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css" />
  <link rel="stylesheet" href="{{ url_for('static', filename='netscout.css') }}" />
  <style>
    /* Layout: left content (map + alerts) and right log panel */
    #mainWrap { display:flex; gap:12px; height: calc(100vh - 200px); padding: 8px; box-sizing: border-box; }
    #leftCol { flex: 0 0 75%; display:flex; flex-direction:column; gap:8px; }
    #rightCol { flex: 0 0 25%; display:flex; flex-direction:column; gap:8px; background:var(--panel-bg); padding:8px; border-left:1px solid var(--table-border); }
    /* Map height increased to 75vh */
    #map { height: 75vh; min-height: 420px; width: 100%; }
    #logBox { flex:1; display:flex; flex-direction:column; gap:8px; }
    #logTail { flex:1; background:#0b1220; color:#e6eef8; padding:8px; border-radius:6px; overflow:auto; font-family: monospace; font-size:12px; white-space:pre-wrap; }
    #logControls { display:flex; gap:8px; align-items:center; }
    select, input { padding:6px; border-radius:4px; border:1px solid var(--table-border); background:transparent; color:var(--panel-text); }
    .control-row { display:flex; gap:8px; align-items:center; }
    /* small icon button style for auto-zoom (Leaflet control uses leaflet-bar) */
    .leaflet-bar a.autozoom { font-size:16px; line-height:18px; text-align:center; width:34px; height:34px; display:block; }
  </style>
</head>
<body>
  <div id="topbar" data-theme="dark" style="background:#0b3d91;">
    <div style="display:flex; align-items:center; gap:12px;">
      <h3 style="margin:0; font-weight:600;">Net-Scout</h3>
      <div style="opacity:0.9; font-size:0.9rem;">Investigate suspicious network activity</div>
    </div>
    <div style="flex:1"></div>
    <div id="controls">
      <div style="display:flex; gap:8px; align-items:center;">
        <label style="color:#fff; font-size:0.9rem;">Theme</label>
        <button id="themeDarkBtn" class="small">Dark</button>
        <button id="themeLightBtn" class="small">Light</button>
      </div>
      <label for="sinceSelect" style="color:#fff; font-size:0.9rem; margin-left:12px;">Window</label>
      <select id="sinceSelect" class="small">
        <option value="1 hour">Last 1 hour</option>
        <option value="6 hours">Last 6 hours</option>
        <option value="12 hours">Last 12 hours</option>
        <option value="24 hours">Last 24 hours</option>
        <option value="7 days">Last 7 days</option>
      </select>
      <button id="runScanBtn" class="btn small">Run Scan</button>
      <button id="runScanEnrichBtn" class="btn small">Run Scan + Enrich</button>
      <button id="refreshBtn" class="btn secondary small">Refresh</button>
    </div>
  </div>

  <!-- Status area -->
  <div style="display:flex; gap:12px; padding:10px; align-items:center; background:var(--panel-bg); color:var(--panel-text);">
    <div style="display:flex; flex-direction:column;">
      <div style="display:flex; align-items:center;">
        <strong style="margin-right:8px;">Scan</strong>
        <div class="status-bar" id="scanStatusBar"><div class="status-fill" id="scanStatusFill"></div></div>
        <div class="status-label" id="scanStatusLabel">Idle</div>
      </div>
      <div style="font-size:0.85rem; margin-top:6px;" class="muted">Last scan: <span id="lastScanTime">never</span></div>
    </div>

    <div style="display:flex; flex-direction:column;">
      <div style="display:flex; align-items:center;">
        <strong style="margin-right:8px;">Enrich</strong>
        <div class="status-bar" id="enrichStatusBar"><div class="status-fill" id="enrichStatusFill"></div></div>
        <div class="status-label" id="enrichStatusLabel">Idle</div>
      </div>
      <div style="font-size:0.85rem; margin-top:6px;" class="muted">Last enrich: <span id="lastEnrichTime">never</span></div>
    </div>

    <div style="flex:1"></div>

    <div style="display:flex; gap:8px; align-items:center;">
      <label class="muted">Bulk enrich newest</label>
      <input id="bulkEnrichCount" type="number" value="10" min="1" max="500" style="width:80px" class="filter-input" />
      <button id="bulkEnrichBtn" class="btn small">Start</button>
      <a href="/enrichment_cache" style="color:inherit; text-decoration:none; margin-left:8px;" class="small">Enrichment Cache</a>
    </div>
  </div>

  <div id="mainWrap">
    <div id="leftCol">
      <div id="map"></div>

      <div id="alerts">
        <div style="display:flex; justify-content:space-between; align-items:center; gap:12px;">
          <div style="display:flex; gap:12px; align-items:center;">
            <strong>Alerts</strong>
            <div class="filters">
              <select id="filterType" class="filter-input">
                <option value="">All types</option>
                <option value="horizontal_scan">horizontal_scan</option>
                <option value="vertical_scan">vertical_scan</option>
                <option value="high_connection_volume">high_connection_volume</option>
              </select>
              <input id="filterSrc" placeholder="Src IP (or partial)" class="filter-input" />
              <input id="filterDst" placeholder="Dst IP (or partial)" class="filter-input" />
              <label style="margin-left:6px;">Min score</label>
              <input id="minScore" type="number" value="0" min="0" max="100" style="width:64px" class="filter-input" />
              <button id="applyFiltersBtn" class="btn small">Apply</button>
              <button id="clearFiltersBtn" class="btn secondary small">Clear</button>

              <!-- Exclude private src IPs checkbox -->
              <label style="margin-left:6px; display:flex; align-items:center; gap:6px;">
                <input id="excludePrivate" type="checkbox" /> <span class="muted">Exclude 192.168.*</span>
              </label>
            </div>
          </div>

          <div style="display:flex; gap:12px; align-items:center;">
            <!-- Auto-refresh enable and interval -->
            <label style="display:flex; align-items:center; gap:6px;">
              <input id="autoRefreshEnabled" type="checkbox" checked /> <span class="muted">Auto-refresh</span>
            </label>
            <select id="refreshInterval" class="filter-input" title="Refresh interval">
              <option value="30">30s</option>
              <option value="60" selected>60s</option>
              <option value="120">120s</option>
              <option value="300">300s</option>
            </select>
            <div class="muted">Auto-refresh: <span id="autoRefreshStatus">on (60s)</span></div>
          </div>
        </div>

        <table id="alertsTable" style="width:100%; border-collapse:collapse; margin-top:8px;">
          <thead>
            <tr style="text-align:left; border-bottom:1px solid var(--table-border);">
              <th style="padding:6px">ID</th>
              <th>Type</th>
              <th>Src</th>
              <th>Dst</th>
              <th>Score</th>
              <th>When</th>
              <th>Status</th>
              <th>Actions</th>
            </tr>
          </thead>
          <tbody></tbody>
        </table>
      </div>
    </div>

    <div id="rightCol">
      <div style="display:flex; justify-content:space-between; align-items:center;">
        <strong>Logs</strong>
        <div id="logControls">
          <select id="logSelect"></select>
          <button id="refreshLogBtn" class="btn small">Refresh</button>
          <label class="muted">Auto-tail</label>
          <input id="autoTail" type="checkbox" checked />
        </div>
      </div>

      <div id="logBox">
        <div id="logTail">No log selected</div>
        <div style="display:flex; gap:8px; align-items:center;">
          <label class="muted">Lines</label>
          <input id="logLines" type="number" value="200" min="10" max="5000" style="width:80px" />
          <button id="downloadLogBtn" class="btn small">Download</button>
        </div>
      </div>
    </div>
  </div>

  <script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js"></script>
  <script src="{{ url_for('static', filename='netscout.js') }}"></script>

  <script>
    // Log panel wiring (unchanged)
    (function() {
      async function fetchLogs() {
        try {
          const res = await fetch('/api/logs');
          const data = await res.json();
          return data.logs || [];
        } catch (e) {
          console.error('fetchLogs failed', e);
          return [];
        }
      }

      async function populateLogSelect() {
        const sel = document.getElementById('logSelect');
        sel.innerHTML = '';
        const logs = await fetchLogs();
        if (!logs.length) {
          const opt = document.createElement('option');
          opt.value = '';
          opt.text = 'No logs';
          sel.appendChild(opt);
          document.getElementById('logTail').textContent = 'No logs found';
          return;
        }
        logs.forEach(l => {
          const opt = document.createElement('option');
          opt.value = l.name;
          opt.text = `${l.name} (${l.mtime})`;
          sel.appendChild(opt);
        });
        sel.selectedIndex = 0;
        await refreshLogTail();
      }

      async function refreshLogTail() {
        const sel = document.getElementById('logSelect');
        const name = sel.value;
        const lines = Number(document.getElementById('logLines').value || 200);
        if (!name) {
          document.getElementById('logTail').textContent = 'No log selected';
          return;
        }
        try {
          const res = await fetch(`/api/log_tail?name=${encodeURIComponent(name)}&lines=${lines}`);
          const data = await res.json();
          if (data.lines) {
            document.getElementById('logTail').textContent = data.lines.join('\n');
            const el = document.getElementById('logTail');
            el.scrollTop = el.scrollHeight;
          } else {
            document.getElementById('logTail').textContent = 'No content';
          }
        } catch (e) {
          console.error('refreshLogTail failed', e);
          document.getElementById('logTail').textContent = 'Failed to load log';
        }
      }

      document.addEventListener('DOMContentLoaded', () => {
        populateLogSelect();
        document.getElementById('refreshLogBtn').addEventListener('click', refreshLogTail);
        document.getElementById('logSelect').addEventListener('change', refreshLogTail);
        // auto-tail
        setInterval(() => {
          if (document.getElementById('autoTail').checked) refreshLogTail();
        }, 3000);
        // download button
        document.getElementById('downloadLogBtn').addEventListener('click', () => {
          const name = document.getElementById('logSelect').value;
          if (!name) return alert('No log selected');
          window.open(`/api/log_tail?name=${encodeURIComponent(name)}&lines=5000`, '_blank');
        });
      });
    })();
  </script>
</body>
</html>
